
<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-N8DWPRM5');</script>
<!-- End Google Tag Manager -->

  
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Registrations</title>

  <!-- Excel Export Library -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body { font-family: Poppins, Arial, sans-serif; padding: 20px; background: #f5f6fa; }
    h2 { margin-bottom: 10px; color:#2ac516; }
    .stats { display: flex; gap: 20px; margin-bottom: 20px; }
    .card { background: #fff; padding: 16px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,.08); }
    .card h3 { margin: 0; font-size: 14px; color: #666; }
    .card p { font-size: 30px; margin: 6px 0 0; font-weight: bold; }
    .controls { display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; }
    input { padding: 10px; width: 260px; border-radius: 8px; border:1px solid #ccc; }
    button { padding: 10px 14px; cursor: pointer; border: none; border-radius: 8px; background: #007bff; color: #fff; }
    table { width: 100%; border-collapse: collapse; background: #fff; }
    th, td { padding: 10px; border: 1px solid #e1e1e1; text-align: left; font-size:14px; }
    th { background: #f0f4ff; }
  </style>
</head>
<body>

  <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-N8DWPRM5"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

  <h2>Admin Dashboard</h2>

  <!-- Statistics -->
  <div class="stats">
    <div class="card">
      <h3>Total Registered Youths</h3>
      <p id="totalCount">0</p>
    </div>
  </div>

  <!-- Controls -->
  <div class="controls">
    <input type="text" id="searchInput" placeholder="Search by name, phone, church" />
    <button onclick="exportToExcel()">Export to Excel</button>
  </div>

  <!-- Table -->
  <table id="usersTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Name</th>
        <th>Phone</th>
        <th>Age</th>
        <th>Gender</th>
        <th>Local Church</th>
        <th>Role</th>
        <th>Leadership Level</th>
        <th>Position</th>
        <th>Small Christian Community</th>
        <th>MPESA Code</th>
        <th>Registered At</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
const firebaseConfig = {
  apiKey: "AIzaSyBw90VniQ8yVJiIPAAXiXO3qA_kpGDrz6w",
  authDomain: "registrations-5594b.firebaseapp.com",
  projectId: "registrations-5594b",
  storageBucket: "registrations-5594b.firebasestorage.app",
  messagingSenderId: "811011800366",
  appId: "1:811011800366:web:dd3c191aa20f8bc43a0ebf",
  measurementId: "G-YVRZ1WHD8R"
};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const tableBody = document.querySelector('#usersTable tbody');
    const totalCount = document.getElementById('totalCount');
    const searchInput = document.getElementById('searchInput');

    let allUsers = [];

    // Listen to Firestore changes
    onSnapshot(collection(db, 'registrations'), (snapshot) => {
      allUsers = [];
      snapshot.forEach(doc => {
        allUsers.push({ id: doc.id, ...doc.data() });
      });

      // Sort newest first
      allUsers.sort((a, b) => (b.createdAt?.toMillis?.() || 0) - (a.createdAt?.toMillis?.() || 0));

      totalCount.textContent = allUsers.length;
      renderTable(allUsers);
    });

    function renderTable(data) {
      tableBody.innerHTML = '';
      data.forEach((user, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${user.name || ''}</td>
          <td>${user.phone || ''}</td>
          <td>${user.age || ''}</td>
          <td>${user.gender || ''}</td>
          <td>${user.localChurch || ''}</td>
          <td>${user.role || ''}</td>
          <td>${user.level || ''}</td>
          <td>${user.position || ''}</td>
          <td>${user.smallChristianCommunity || ''}</td>
          <td>${user.mpesaCode || ''}</td>
          <td>${user.createdAt?.toDate?.().toLocaleString() || ''}</td>
        `;
        tableBody.appendChild(tr);
      });
    }

    // Search
    searchInput.addEventListener('input', () => {
      const value = searchInput.value.toLowerCase();
      const filtered = allUsers.filter(u =>
        (u.name || '').toLowerCase().includes(value) ||
        (u.phone || '').toLowerCase().includes(value) ||
        (u.localChurch || '').toLowerCase().includes(value)
      );
      renderTable(filtered);
    });

    // Export to Excel
    window.exportToExcel = function () {
      const exportData = allUsers.map(u => ({
        Name: u.name || '',
        Phone: u.phone || '',
        Age: u.age || '',
        Gender: u.gender || '',
        LocalChurch: u.localChurch || '',
        Role: u.role || '',
        Level: u.level || '',
        Position: u.position || '',
        SmallChristianCommunity: u.smallChristianCommunity || '',
        MPESACode: u.mpesaCode || '',
        RegisteredAt: u.createdAt?.toDate?.().toLocaleString() || ''
      }));

      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Registrations');
      XLSX.writeFile(wb, 'night_vigil_registrations.xlsx');
    }
  </script>

</body>
</html>

